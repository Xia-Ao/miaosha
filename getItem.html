<!DOCTYPE html>
<html lang="en">
<head>
    <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
    <title></title>
    <link rel="stylesheet" type="text/css" href="static/assets/global/plugins/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="static/assets/global/css/components.css">
    <link rel="stylesheet" type="text/css" href="static/assets/admin/pages/css/login.css">

    <script src="./static/assets/global/plugins/jquery-1.11.0.min.js" type="text/javascript"></script>
</head>

<body>
<div class="login">
    <div class="content">
        <h3 class="form-title">创建商品</h3>
        <div class="" style="color: red;">
            <span id="startTime"></span><br>
            <span id="countDown"></span>
        </div>

        <div class="form-group">
            <label class="control-label">商品名称</label>
            <div id="title" type="text"></div>
            <label class="control-label">商品描述</label>
            <div id="description" type="text"></div>
            <div id="priceContainer">
                <label class="control-label">商品价格</label>
                <div id="price" type="text"></div>
            </div>
            <div id="promoPriceContainer">
                <label class="control-label" style="color: red;">秒杀价格</label>
                <div input id="promoPrice" type="text" style="color: red; font-size: 40px"></div>
            </div>
            <label class="control-label">商品销量</label>
            <div input id="sales" type="text"></div>
            <label class="control-label">商品库存</label>
            <div id="stock" type="text"></div>
            <label class="control-label">商品图片</label>
            <div type="text" class="">
                <img src="" width="200px" id="imgUrl" alt="">
            </div>
        </div>
        <div class="form-actions">
            <button id="orderBtn" class="btn blue" type="submit">下单</button>
        </div>
    </div>

</div>


<script>
    jQuery(document).ready(function () {

        function getQueryString(name) {
            var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)", "i");
            var r = window.location.search.substr(1).match(reg);
            if (r != null) return unescape(r[2]);
            return null;
        }

        let itemInfo;
        init();

        function init() {
            $.ajax({
                type: 'GET',
                url: 'http://localhost:8090/item/getItem',
                xhrFields: {withCredentials: true},
                data: {
                    id: getQueryString("id")
                },
                success: function (data) {
                    if (data.status === 'success') {
                        itemInfo = data.data;
                        // reloadDom(itemInfo);
                        setInterval(function () {
                            reloadDom(itemInfo)
                        }, 1000);
                    } else {
                        alert('创建失败：' + data.data.errMsg);
                    }

                },
                error: function (data) {
                    alert('请求出错' + data)
                }
            })
        }

        function reloadDom(item) {

            $('#title').text(item.title);
            $('#description').text(item.description);
            $('#sales').text(item.sales);
            $('#stock').text(item.stock);
            $("#imgUrl").attr('src', item.imgUrl);


            if (item.promoStatus == 1) {
                // 秒杀活动还未开始， 设置开始时间
                let startTime = new Date(item.startTime.replace(new RegExp("-", "gm"), '/')).getTime();

                let nowTime = Date.parse(new Date());
                let delayTime = (startTime - nowTime) / 1000;

                $('#startTime').text('秒杀活动还未看开始，开始时间：' + item.startTime);
                $('#countDown').text('距离活动开始还剩：' + delayTime + '秒');

                // $('#priceContainer').css("display", "block");
                $('#price').text(item.price);
                // $('#promoPriceContainer').css("display", "block");
                $('#promoPrice').text(item.promoPrice);
                $('#orderBtn').attr("disabled", true)
            } else if (item.promoStatus == 2) {
                // 秒杀活动正在进行中，设置结束时间
                let endTime = new Date(item.endTime.replace(new RegExp("-", "gm"), '/')).getTime();
                let nowTime = Date.parse(new Date());
                let delayTime = (endTime - nowTime) / 1000;

                $('#startTime').text('秒杀活动正在进行中，开始时间：' + item.startTime);
                $('#countDown').text('距离活动结束还剩：' + delayTime + '秒');
                $('#priceContainer').css("display", 'none');
                $('#promoPriceContainer').css("display", "block");
                $('#promoPrice').text(item.promoPrice);

                // 给itemInfo赋值
                itemInfo.promoId = item.promoId;

                $('#orderBtn').attr('disabled', false)

            } else {
                $('#priceContainer').css("display", 'block');
                $('#price').text(item.price);
                $('#promoPriceContainer').css("display", "none");
            }

        }


        $("#orderBtn").on('click', function () {
            $.ajax({
                type: 'POST',
                contentType: 'application/x-www-form-urlencoded',
                url: 'http://localhost:8090/order/createOrder',
                xhrFields: {withCredentials: true},
                data: {
                    itemId: itemInfo.id,
                    amount: 1,
                    promoId: itemInfo.promoId
                },
                success: function (data) {
                    if (data.status === 'success') {
                        alert('下单成功!');
                        init();
                    } else {
                        alert('下单失败：' + data.data.errMsg);
                        if (data.data.errCode == 20003) {
                            window.location.href = 'login.html';
                        }
                    }

                },
                error: function (data) {
                    alert('请求出错' + data)
                }
            })
        })
    })
</script>
</body>

</html>